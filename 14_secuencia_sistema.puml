@startuml
!pragma charset UTF-8
skinparam defaultFontName Arial
title Diagrama de Secuencia - Creación y Gestión de Trámite

actor "Ciudadano" as C
participant "Portal Web" as P
participant "Ventanilla" as V
participant "AppSheet" as A
participant "Apps Script" as AS
participant "Google Sheets" as GS
participant "Google Drive" as GD
actor "Técnico" as T
actor "Supervisor" as S

== Registro de Trámite ==
C -> V : Entrega solicitud y documentos
activate V
V -> V : Valida requisitos
V -> P : Registra trámite
activate P
P -> A : Crea nuevo trámite
activate A
A -> GS : INSERT tramite
activate GS
GS --> A : ID generado
deactivate GS
A -> GD : Crea carpeta expediente
activate GD
GD --> A : URL carpeta
deactivate GD
A --> P : Trámite creado
deactivate A
P --> V : Confirmación
deactivate P
V --> C : Entrega número de expediente
deactivate V

== Asignación Automática ==
A -> AS : Trigger: Nuevo trámite
activate AS
AS -> GS : Consulta técnicos disponibles
activate GS
GS --> AS : Lista técnicos
deactivate GS
AS -> AS : Algoritmo Round-Robin
AS -> GS : UPDATE asignar técnico
activate GS
GS --> AS : OK
deactivate GS
AS -> A : Notificar asignación
deactivate AS

== Notificaciones ==
A -> T : Email/WhatsApp: Nuevo trámite asignado
A -> S : Notifica panel supervisor
A -> C : SMS: Trámite registrado

== Gestión de Fase ==
T -> A : Accede a trámite
activate A
A -> GS : SELECT tramite + documentos
activate GS
GS --> A : Datos
deactivate GS
A --> T : Muestra expediente
T -> T : Realiza análisis técnico
T -> A : Carga informe
A -> GD : Sube archivo
activate GD
GD --> A : URL archivo
deactivate GD
A -> GS : UPDATE fase completada
activate GS
GS --> A : OK
deactivate GS

== Transición de Fase ==
A -> AS : Trigger: Fase completada
activate AS
AS -> GS : Identifica siguiente fase
activate GS
GS --> AS : Siguiente fase
deactivate GS
AS -> GS : Asigna nuevo técnico
AS -> A : Nueva asignación
deactivate AS
A -> T : Notifica nuevo técnico
A -> S : Actualiza dashboard
deactivate A

@enduml

